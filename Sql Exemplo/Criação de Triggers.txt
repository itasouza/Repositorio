--gatilho para atualizar a tabela de pergunta com o código do moderador 

CREATE TRIGGER TGR_TB_PERGUNTA
 ON [dbo].[TB_PERGUNTA]
 FOR INSERT
AS
BEGIN
   DECLARE @IDCATEGORIA INT
   DECLARE @IDMODERADOR INT
  
   SELECT  @IDCATEGORIA = IDCATEGORIA FROM INSERTED
   SELECT  @IDMODERADOR = IDMODERADOR FROM TB_MODERADOR WHERE IDCATEGORIA = @IDCATEGORIA
   UPDATE TB_PERGUNTA SET  IDMODERADOR = @IDMODERADOR, BLOQUEIO_PERGUNTA='N', EXCLUIR_PERGUNTA='N'  
END


--gatilho para gravar os dados da resposta de acordo com a pergunta
--idmoderador, resposta selecionada, nota e bloqueio resposta
CREATE TRIGGER TGR_TB_RESPOSTA
 ON TB_RESPOSTA
 FOR INSERT
AS
BEGIN
   DECLARE @IDMODERADOR INT
   SELECT  @IDMODERADOR = IDMODERADOR FROM TB_PERGUNTA INSERTED
   UPDATE TB_RESPOSTA SET  IDMODERADOR = @IDMODERADOR, RESPOSTA_SELECIONADA='N', NOTA_RESPOSTA='0',BLOQUEIO_RESPOSTA='N'  
END
GO



--gatilho para gravar os dados do usuário
CREATE TRIGGER TGR_TB_USUARIO_INSERT
 ON TB_USUARIO
 FOR INSERT
AS
BEGIN
   UPDATE TB_USUARIO SET  EXCLUIR_CADASTRO = 'N', DATA_CADASTRO = CONVERT(VARCHAR, GETDATE(), 20)
END
GO






--gatilho para exclusão dos dados do usuário 
CREATE TRIGGER TGR_TB_USUARIO_UPDATE
 ON TB_USUARIO
 FOR UPDATE
AS
BEGIN
   DECLARE @EXCLUIR CHAR(1)
   SELECT @EXCLUIR = EXCLUIR_CADASTRO FROM TB_USUARIO INSERTED
   
   IF (@EXCLUIR = 'S')
     BEGIN
      UPDATE TB_USUARIO SET  EXCLUIR_CADASTRO = 'S', DATA_EXCLUSAO = CONVERT(VARCHAR, GETDATE(), 20), DATA_CADASTRO = NULL
     END
     
     IF (@EXCLUIR = 'N')
     BEGIN
      UPDATE TB_USUARIO SET  EXCLUIR_CADASTRO = 'N', DATA_CADASTRO = CONVERT(VARCHAR, GETDATE(), 20), DATA_EXCLUSAO = NULL
     END   
     
END
GO
